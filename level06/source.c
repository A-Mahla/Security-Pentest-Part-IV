# include <stdio.h>
# include <stdlib.h>
# include <string.h>
# include <sys/ptrace.h>


int	auth( char *buffer, unsigned int *n ) {

	int		len; // ebp-0xc
	int		i; // ebp-0x10
	int		y; // ebp-0x14
	int		eax;
	int		ecx;

	buffer[strcspn(buffer, "\n")] = '\0';
	len = strnlen( buffer, 32 );
	if ( len < 5 )
		return 1;
	if ( ptrace( 0, 0, 1, NULL ) == -1 ) {
		puts( "\033[32m.---------------------------." );
		puts( "\033[31m| !! TAMPERING DETECTED !!  |" );
		puts( "\033[32m.---------------------------." );
		return 1;
	}
	i = (buffer[3] ^ 0x1337) + 0x5eeded;
	y = 0;
	if ( *buffer < 31 )
		return 1;
	while ( y < len ) {
		eax = (int)(buffer[y]);
		eax ^= i;
		ecx = eax;
		eax -= 0x88233b2b;
		eax >> 1;
		eax += 0x88233b2b;
		eax >> 10;
		eax *= 0x539;
		ecx -= eax;
		eax = ecx;
		i += eax;
		y += 1;
	}
	if ( (long)n != i )
		return 1;
	return 0;

}


int	main(void) {

	unsigned int	*n; // esp+0x28
	char			buffer[32]; // esp+0x2c

	puts( "***********************************" );
	puts( "*\t\tlevel06\t\t  *" );
	puts( "***********************************" );
	printf( "-> Enter Login: " );
	fgets( buffer, 32, stdin );
	puts( "***********************************" );
	puts( "***** NEW ACCOUNT DETECTED ********" );
	puts( "***********************************" );
	printf( "-> Enter Serial: " );
	scanf( "%u", n );
	if ( auth(buffer, n) != 0 )
		return 1;
	puts( "Authenticated!" );
	system( "/bin/sh" );
	return 0;

}
